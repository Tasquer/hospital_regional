{% extends 'components/Layout/base_extendido.html' %}

{% block content_main %}
<section class="mx-auto max-w-6xl space-y-6 text-white">
  <header class="flex flex-wrap items-start justify-between gap-4">
    <div>
      <p class="text-sm font-semibold text-indigo-300 uppercase tracking-wide">
        Clínica · Trazabilidad
      </p>
      <h1 class="text-3xl font-bold leading-tight text-white">
        Ficha de trazabilidad de paciente
      </h1>
      <p class="text-sm text-gray-400">
        Madre → parto → recién nacido → alta clínica.
      </p>
    </div>
    <a href="{% url 'clinica:paciente_list' %}"
       class="text-sm font-semibold text-indigo-200 hover:text-white">
      ← Volver a pacientes
    </a>
  </header>

  <div class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl shadow-black/20">
    <h2 class="text-lg font-semibold text-white">Datos de la madre</h2>
    <dl class="mt-4 grid gap-4 text-sm sm:grid-cols-2 lg:grid-cols-3">
      <div>
        <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">Nombre</dt>
        <dd class="mt-1 text-sm text-gray-100">{{ paciente.nombre_completo }}</dd>
      </div>
      <div>
        <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">RUT</dt>
        <dd class="mt-1 text-sm text-gray-100">{{ paciente.rut }}</dd>
      </div>
      <div>
        <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">Fecha de nacimiento</dt>
        <dd class="mt-1 text-sm text-gray-100">{{ paciente.fecha_nacimiento|date:"d/m/Y" }}</dd>
      </div>
      <div>
        <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">Teléfono</dt>
        <dd class="mt-1 text-sm text-gray-100">{{ paciente.telefono|default:"Sin registro" }}</dd>
      </div>
      <div>
        <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">Dirección</dt>
        <dd class="mt-1 text-sm text-gray-100">{{ paciente.direccion|default:"Sin registro" }}</dd>
      </div>
      <div>
        <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">Estado civil</dt>
        <dd class="mt-1 text-sm text-gray-100">{{ paciente.get_estado_civil_display|default:"Sin registro" }}</dd>
      </div>
    </dl>
  </div>

  <div class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl shadow-black/20 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-white">Partos asociados</h2>
      <a href="{% url 'clinica:parto_create' %}?paciente={{ paciente.pk }}" class="text-sm font-semibold text-indigo-300 hover:text-white">Registrar nuevo parto →</a>
    </div>

    {% if trazabilidad %}
      <div class="space-y-6">
        {% for parto in trazabilidad %}
          <article class="rounded-2xl border border-white/10 bg-slate-950/70 p-5 space-y-4">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <p class="text-sm text-gray-400">Parto {{ forloop.counter }}</p>
                <h3 class="text-xl font-semibold text-white">{{ parto.fecha_hora|date:"d/m/Y H:i" }}</h3>
                <p class="text-sm text-gray-300">{{ parto.get_tipo_parto_display }}</p>
              </div>
              <div class="flex flex-wrap items-center gap-2">
                {% if parto.complicaciones %}
                  <span class="rounded-full bg-rose-500/20 px-3 py-1 text-xs font-semibold text-rose-200">Con complicaciones</span>
                {% else %}
                  <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200">Sin complicaciones</span>
                {% endif %}
                {% if parto.alta_registrada %}
                  <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200">Alta registrada</span>
                {% else %}
                  <span class="rounded-full bg-amber-500/20 px-3 py-1 text-xs font-semibold text-amber-200">Alta pendiente</span>
                {% endif %}
              </div>
            </div>

            <dl class="grid gap-4 text-sm md:grid-cols-2">
              <div>
                <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">Profesional</dt>
                <dd class="mt-1 text-gray-100">
                  {% if parto.personal_responsable %}
                    {{ parto.personal_responsable.get_full_name|default:parto.personal_responsable }}
                  {% else %}
                    —
                  {% endif %}
                </dd>
              </div>
              <div>
                <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">Sala / pabellón</dt>
                <dd class="mt-1 text-gray-100">{{ parto.sala|default:"Sin registro" }}</dd>
              </div>
              <div>
                <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">Posición</dt>
                <dd class="mt-1 text-gray-100">{{ parto.get_posicion_parto_display|default:"Sin registro" }}</dd>
              </div>
              <div>
                <dt class="text-xs font-semibold uppercase tracking-wide text-gray-400">Duración trabajo parto</dt>
                <dd class="mt-1 text-gray-100">
                  {% if parto.duracion_trabajo_parto_min %}
                    {{ parto.duracion_trabajo_parto_min }} min
                  {% else %}
                    Sin registro
                  {% endif %}
                </dd>
              </div>
            </dl>
            {% if parto.complicaciones %}
              <p class="text-sm text-gray-300"><span class="font-semibold">Complicaciones:</span> {{ parto.complicaciones }}</p>
            {% endif %}

            <div class="flex flex-wrap gap-3 text-xs font-semibold">
              <a href="{% url 'clinica:parto_detail' parto.pk %}" class="rounded-full border border-white/15 px-3 py-1 text-indigo-200 hover:text-white">Ver detalle</a>
              <a href="{% url 'clinica:recien_nacido_create' %}?parto={{ parto.pk }}" class="rounded-full border border-white/15 px-3 py-1 text-indigo-200 hover:text-white">Agregar RN</a>
              {% if parto.alta_registrada %}
                <a href="{% url 'clinica:alta_update' parto.alta_registrada.pk %}" class="rounded-full border border-white/15 px-3 py-1 text-indigo-200 hover:text-white">Editar alta</a>
              {% else %}
                <a href="{% url 'clinica:alta_create' %}?parto={{ parto.pk }}" class="rounded-full border border-amber-300/50 px-3 py-1 text-amber-200 hover:border-amber-200">Registrar alta</a>
              {% endif %}
            </div>

            <div class="border-t border-white/5 pt-4 space-y-3">
              <div class="flex items-center justify-between">
                <h4 class="text-sm font-semibold text-white">Recién nacidos</h4>
                <span class="text-xs text-gray-400">{{ parto.recien_nacidos.all|length }} registrado(s)</span>
              </div>
              {% with recien_nacidos=parto.recien_nacidos.all %}
                {% if recien_nacidos %}
                  <div class="grid gap-3 md:grid-cols-2">
                    {% for rn in recien_nacidos %}
                    <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-3 space-y-2">
                      <div class="flex items-center justify-between">
                        <p class="text-sm font-semibold text-white">{{ rn.identificador }}</p>
                        {% if rn.apgar1 is not None and rn.apgar1 < 7 %}
                          <span class="rounded-full bg-rose-500/20 px-2.5 py-0.5 text-[0.65rem] font-semibold text-rose-200">APGAR 1' {{ rn.apgar1 }}</span>
                        {% else %}
                          <span class="rounded-full bg-emerald-500/20 px-2.5 py-0.5 text-[0.65rem] font-semibold text-emerald-200">APGAR 1' {{ rn.apgar1|default:"-" }}</span>
                        {% endif %}
                      </div>
                      <p class="text-xs text-gray-400">Sexo: {{ rn.get_sexo_display }}</p>
                      <p class="text-xs text-gray-400">Peso {{ rn.peso_gramos }} g · Talla {{ rn.talla_cm }} cm</p>
                      <p class="text-xs text-gray-400">APGAR 5' {{ rn.apgar5|default:"-" }}</p>
                      {% if rn.derivacion %}
                        <p class="text-xs text-gray-500">Derivación: {{ rn.derivacion }}</p>
                      {% endif %}
                      <a href="{% url 'clinica:recien_nacido_detail' rn.pk %}" class="text-xs font-semibold text-indigo-300 hover:text-white">Ver ficha →</a>
                    </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="rounded-2xl border border-dashed border-white/10 bg-slate-900/40 p-4 text-sm text-gray-400">
                    Aún no se registran recién nacidos para este parto. <a href="{% url 'clinica:recien_nacido_create' %}?parto={{ parto.pk }}" class="font-semibold text-indigo-300 hover:text-white">Registrar RN →</a>
                  </div>
                {% endif %}
              {% endwith %}
            </div>

            <div class="border-t border-white/5 pt-4 space-y-2">
              <div class="flex items-center justify-between">
                <h4 class="text-sm font-semibold text-white">Alta clínica</h4>
                {% if parto.alta_registrada %}
                  <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200">Completada</span>
                {% else %}
                  <span class="rounded-full bg-amber-500/20 px-3 py-1 text-xs font-semibold text-amber-200">Pendiente</span>
                {% endif %}
              </div>
              {% if parto.alta_registrada %}
                <dl class="grid gap-3 text-sm md:grid-cols-2">
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-gray-400">Fecha de alta</dt>
                    <dd class="mt-1 text-gray-100">{{ parto.alta_registrada.fecha_alta|date:"d/m/Y H:i" }}</dd>
                  </div>
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-gray-400">Tipo de alta</dt>
                    <dd class="mt-1 text-gray-100">{{ parto.alta_registrada.get_tipo_alta_display }}</dd>
                  </div>
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-gray-400">Profesional</dt>
                    <dd class="mt-1 text-gray-100">
                      {% if parto.alta_registrada.profesional_responsable %}
                        {{ parto.alta_registrada.profesional_responsable.get_full_name|default:parto.alta_registrada.profesional_responsable }}
                      {% else %}
                        —
                      {% endif %}
                    </dd>
                  </div>
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-gray-400">Próxima cita</dt>
                    <dd class="mt-1 text-gray-100">
                      {% if parto.alta_registrada.proxima_cita %}
                        {{ parto.alta_registrada.proxima_cita|date:"d/m/Y" }}
                      {% else %}
                        Sin registro
                      {% endif %}
                    </dd>
                  </div>
                </dl>
                <p class="text-sm text-gray-300">
                  <span class="font-semibold">Condición:</span>
                  <span class="whitespace-pre-line">{{ parto.alta_registrada.condicion_egreso }}</span>
                </p>
                {% if parto.alta_registrada.observaciones %}
                  <p class="text-sm text-gray-400">{{ parto.alta_registrada.observaciones }}</p>
                {% endif %}
                {% if parto.alta_registrada.requiere_seguimiento %}
                  <p class="text-xs font-semibold text-amber-300">Requiere seguimiento posterior.</p>
                {% endif %}
              {% else %}
                <p class="text-sm text-gray-400">Sin alta registrada.</p>
                <a href="{% url 'clinica:alta_create' %}?parto={{ parto.pk }}" class="text-sm font-semibold text-amber-300 hover:text-white">Registrar alta →</a>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm text-gray-300">Este paciente no tiene partos registrados.</p>
    {% endif %}
  </div>

  {% include 'components/mensajes.html' %}
</section>
{% endblock content_main %}
