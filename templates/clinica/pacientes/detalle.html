{% extends 'components/Layout/base_extendido.html' %}

{% block content_main %}
<section class="space-y-6 text-white">
  <div class="flex flex-wrap items-start justify-between gap-4">
    <div>
      <p class="text-sm font-semibold text-indigo-300 uppercase tracking-wide">Ficha de paciente</p>
      <h1 class="text-3xl font-bold text-white">{{ paciente.nombre_completo }}</h1>
      <p class="text-sm text-gray-400">
        RUT {{ paciente.rut }} · {{ paciente.get_sexo_display }} · {{ paciente.fecha_nacimiento|date:"d/m/Y" }}
      </p>
    </div>
    <div class="flex flex-wrap gap-3">
      <a href="{% url 'clinica:paciente_update' paciente.pk %}" class="rounded-2xl border border-white/15 px-4 py-2 text-sm font-semibold text-gray-200 hover:bg-white/5">
        Editar ficha
      </a>
      <a href="{% url 'clinica:paciente_list' %}" class="rounded-2xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-600/30 hover:bg-indigo-500">
        Volver al listado
      </a>
    </div>
  </div>

  <div class="grid gap-6 lg:grid-cols-3">
    <article class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl shadow-black/20 lg:col-span-2">
      <div class="flex flex-wrap items-center gap-3 text-sm">
        {% if paciente.activo %}
          <span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-300">
            <span class="h-2 w-2 rounded-full bg-emerald-400"></span> Paciente activo
          </span>
        {% else %}
          <span class="inline-flex items-center gap-2 rounded-full bg-rose-500/10 px-3 py-1 text-xs font-semibold text-rose-300">
            <span class="h-2 w-2 rounded-full bg-rose-400"></span> Paciente inactivo
          </span>
        {% endif %}
        <span class="rounded-full bg-white/5 px-3 py-1 text-xs font-semibold text-gray-300">Creado el {{ paciente.fecha_creacion|date:"d/m/Y H:i" }}</span>
        {% if paciente.registrado_por %}
          <span class="rounded-full bg-white/5 px-3 py-1 text-xs font-semibold text-gray-300">Registró {{ paciente.registrado_por.get_full_name|default:paciente.registrado_por }}</span>
        {% endif %}
      </div>
      <div class="mt-4 flex flex-wrap gap-2 text-xs font-semibold">
        <span class="inline-flex items-center gap-2 rounded-full px-3 py-1
          {% if paciente.estado_atencion == 'atendido' %}bg-emerald-500/10 text-emerald-200
          {% elif paciente.estado_atencion == 'en_observacion' %}bg-amber-500/10 text-amber-200
          {% elif paciente.estado_atencion == 'derivado' %}bg-rose-500/10 text-rose-200
          {% else %}bg-sky-500/10 text-sky-200{% endif %}">
          <span class="h-2 w-2 rounded-full bg-current"></span>
          {{ paciente.get_estado_atencion_display }}
        </span>
        <span class="inline-flex items-center gap-2 rounded-full px-3 py-1
          {% if paciente.riesgo_obstetrico == 'alto' %}bg-rose-500/10 text-rose-200
          {% elif paciente.riesgo_obstetrico == 'medio' %}bg-amber-500/10 text-amber-200
          {% else %}bg-emerald-500/10 text-emerald-200{% endif %}">
          <span class="h-2 w-2 rounded-full bg-current"></span>
          Riesgo {{ paciente.get_riesgo_obstetrico_display }}
        </span>
      </div>
      <dl class="mt-6 grid gap-4 text-sm text-gray-300 sm:grid-cols-2">
        <div>
          <dt class="text-gray-400">Teléfono</dt>
          <dd class="text-white">{{ paciente.telefono|default:"Sin teléfono" }}</dd>
        </div>
        <div>
          <dt class="text-gray-400">Correo</dt>
          <dd class="text-white">{{ paciente.email|default:"Sin correo" }}</dd>
        </div>
        <div>
          <dt class="text-gray-400">Consultorio de referencia</dt>
          <dd class="text-white">{{ paciente.consultorio|default:"Sin asignar" }}</dd>
        </div>
        <div>
          <dt class="text-gray-400">Estado civil</dt>
          <dd class="text-white">{{ paciente.get_estado_civil_display|default:"Sin registro" }}</dd>
        </div>
        <div class="sm:col-span-2">
          <dt class="text-gray-400">Dirección</dt>
          <dd class="text-white">{{ paciente.direccion|default:"No registrada" }}</dd>
        </div>
      </dl>
      <div class="mt-6 rounded-2xl border border-white/10 bg-slate-950/60 p-4">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-200">Contacto de emergencia</h3>
        {% if paciente.contacto_emergencia_nombre or paciente.contacto_emergencia_telefono %}
          <p class="mt-2 text-sm text-gray-300">{{ paciente.contacto_emergencia_nombre|default:"Sin nombre" }}</p>
          <p class="text-sm text-gray-400">{{ paciente.contacto_emergencia_telefono|default:"Sin teléfono" }}</p>
        {% else %}
          <p class="mt-2 text-sm text-gray-400">No hay contacto de emergencia registrado.</p>
        {% endif %}
      </div>
    </article>

    <article class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl shadow-black/20 space-y-4">
      <h2 class="text-lg font-semibold text-white">Resumen rápido</h2>
      <dl class="space-y-3 text-sm text-gray-300">
        <div class="flex items-center justify-between">
          <dt class="text-gray-400">Casos clínicos</dt>
          <dd class="text-white">{{ casos_clinicos|length }}</dd>
        </div>
        <div class="flex flex-col text-sm">
          <dt class="text-gray-400">Último caso registrado</dt>
          <dd class="text-white">
            {% with caso=casos_clinicos|first %}
              {% if caso %}
                {{ caso.titulo }} · {{ caso.fecha_creacion|date:"d/m/Y" }}
              {% else %}
                Sin registros
              {% endif %}
            {% endwith %}
          </dd>
        </div>
      </dl>
    </article>
  </div>

  <div class="rounded-3xl border border-white/10 bg-slate-900/70 shadow-2xl shadow-black/20">
    <div class="flex items-center justify-between border-b border-white/5 px-6 py-4">
      <div>
        <h2 class="text-lg font-semibold text-white">Casos clínicos asociados</h2>
        <p class="text-sm text-gray-400">Historial de seguimiento y responsables actuales.</p>
      </div>
      <a href="{% url 'clinica:caso_create' %}?paciente={{ paciente.pk }}" class="rounded-2xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-600/30 hover:bg-indigo-500">
        Nuevo caso
      </a>
    </div>
    <div class="overflow-x-auto">
      <table aria-label="Casos clínicos del paciente" class="mt-6 w-full whitespace-nowrap text-left text-sm text-gray-300">
        <colgroup>
          <col class="w-full lg:w-3/12">
          <col class="lg:w-2/12">
          <col class="lg:w-2/12">
          <col class="lg:w-2/12">
          <col class="lg:w-2/12">
          <col class="lg:w-1/12">
        </colgroup>
        <thead class="border-b border-white/10 text-xs font-semibold uppercase tracking-wide text-gray-400">
          <tr>
            <th scope="col" class="py-3 pl-6 pr-8 sm:pl-8">Título</th>
            <th scope="col" class="px-6 py-3">Especialidad</th>
            <th scope="col" class="px-6 py-3">Prioridad</th>
            <th scope="col" class="px-6 py-3">Estado</th>
            <th scope="col" class="px-6 py-3">Médico responsable</th>
            <th scope="col" class="py-3 pl-6 pr-6 text-right sm:pr-8">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-white/5">
          {% for caso in casos_clinicos %}
            <tr class="transition hover:bg-white/5">
              <td class="py-4 pl-6 pr-8 sm:pl-8">
                <p class="font-semibold text-white">{{ caso.titulo }}</p>
                <p class="text-xs text-gray-400">{{ caso.fecha_creacion|date:"d/m/Y H:i" }}</p>
              </td>
              <td class="px-6 py-4 text-sm text-gray-200">{{ caso.especialidad }}</td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold
                  {% if caso.prioridad == 'alta' %}bg-rose-500/10 text-rose-300{% elif caso.prioridad == 'media' %}bg-amber-500/10 text-amber-200{% else %}bg-emerald-500/10 text-emerald-200{% endif %}">
                  <span class="h-2 w-2 rounded-full
                    {% if caso.prioridad == 'alta' %}bg-rose-400{% elif caso.prioridad == 'media' %}bg-amber-300{% else %}bg-emerald-300{% endif %}"></span>
                  {{ caso.get_prioridad_display }}
                </span>
              </td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold
                  {% if caso.estado == 'cerrado' %}bg-gray-500/10 text-gray-300{% elif caso.estado == 'en_estudio' %}bg-indigo-500/10 text-indigo-200{% else %}bg-sky-500/10 text-sky-200{% endif %}">
                  <span class="h-2 w-2 rounded-full
                    {% if caso.estado == 'cerrado' %}bg-gray-400{% elif caso.estado == 'en_estudio' %}bg-indigo-300{% else %}bg-sky-300{% endif %}"></span>
                  {{ caso.get_estado_display }}
                </span>
              </td>
              <td class="px-6 py-4 text-sm text-gray-200">
                {{ caso.medico_responsable.get_full_name|default:caso.medico_responsable }}
              </td>
              <td class="py-4 pl-6 pr-6 text-right text-sm font-semibold sm:pr-8">
                <a href="{% url 'clinica:caso_detail' caso.pk %}" class="text-indigo-300 hover:text-white">Ver</a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="px-6 py-10 text-center text-sm text-gray-400">
                Aún no existen casos registrados para este paciente.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="rounded-3xl border border-white/10 bg-slate-900/70 shadow-2xl shadow-black/20">
    <div class="flex items-center justify-between border-b border-white/5 px-6 py-4">
      <div>
        <h2 class="text-lg font-semibold text-white">Historia obstétrica</h2>
        <p class="text-sm text-gray-400">Madre → parto → RN → alta, todo en una sola vista.</p>
      </div>
      <a href="{% url 'clinica:parto_create' %}?paciente={{ paciente.pk }}" class="rounded-2xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-600/30 hover:bg-indigo-500">Registrar nuevo parto</a>
    </div>
    <div class="p-6">
      {% url 'clinica:parto_create' as parto_create_url %}
      {% with paciente_id=paciente.pk|stringformat:'s' %}
        {% with nuevo=parto_create_url|add:'?paciente='|add:paciente_id %}
          {% include 'clinica/pacientes/_partos_cards.html' with partos=partos nuevo_parto_url=nuevo %}
        {% endwith %}
      {% endwith %}
    </div>
  </div>

  {% include 'components/mensajes.html' %}
</section>
{% endblock content_main %}
